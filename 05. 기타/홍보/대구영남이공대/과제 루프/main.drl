drl_report_line(ON)
printf = lambda *n: tp_log(' '.join(map(str,n)))

root = [('09x900x909090999x0900x9090x00x0x90000x0909900909909x900x90x990xx0x990900',0,71),
        '22200xxbxx11100',
        '642751300']
find_road_start,find_road_end = root[0][1],root[0][2]

# real board states
live_board = [root[0][0]]+root[1:]

set_tcp('전기그리퍼'); set_tool('tool wei')
set_velx(2400); set_accx(1200); begin_blend(15)

angle = 90
Positions = lambda: [posx(219.87, 339.12, 28.54, angle,180,0),
                               posx(479.17, 158.6, 17.02, angle,180,0),
                               posx(-361.57, 171.15, 15.84, angle,180,0)]

isgrip = 0
def grip(n):
    global isgrip
    if isgrip == n: return -1
    wait(0.18)
    set_tool_digital_outputs([1*n,2*-n])
    wait(0.18)
    isgrip = (0 if n == -1 else 1)

def posing(pos):
    x = [12,5,3][Rn]
    pos,n = [pos] * [72,15,9][Rn],40
    for i in range(1,len(pos)):
        if i % x: pos[i] = trans(pos[i-1],[-n,0,0,0,0,0])
        else: pos[i] = trans(pos[i-x],[0,n + (20 if Rn == 1 else 0),0,0,0,0])
    return pos

up_value =  [[0,0,55,0,0,0],[0,0,35,0,0,0]]
up_pos = lambda: up_value[isgrip]
up = lambda pos: trans(pos,up_pos())

pass_stack,val = 0,0
def move(start,end,ispass = False,limit=True):
    global pass_stack,val,up_value
    for ct,i in enumerate((start,end)):        
        if i == None: continue
        Pos = pos[i] 
        if limit:
            if Rn == 1:
                if start - end in [10,-10]: up_value =  [[0,0,35,0,0,0],[0,0,25,0,0,0]]
                else: up_value =  [[0,0,35,0,0,0],[0,0,5,0,0,0]]
            else:
                up_value =  [[0,0,55,0,0,0],[0,0,35,0,0,0]]
        else:
            up_value =  [[0,0,55,0,0,0],[0,0,85,0,0,0]]
        if Rn == 1:movel(up(Pos))
        elif not pass_stack: movel(up(Pos))
        if ct and ispass: pass_stack += 2      
        if not pass_stack:
            if not ct: val = live_board[Rn][i]
            movel(Pos,None,800)
            grip(-1 if ct else 1)
            live_board[Rn][i] = val if ct else '0'
            movel(up(Pos),None,800)
        else: pass_stack -= 1

def Run(Type):
    global Rn,pos,live_board,angle
    Rn = Type
    angle = 90 if loop_count % 2 else 0
    pos = posing(Positions()[Type])
    Path = result[Type]

    if Type == 0:
        sort_path,find_road_path = Path
        for i in range(len(sort_path)):
            start,end = sort_path[i]
            ispass = i+1 <  len(sort_path) and sort_path[i+1][0] == end
            move(start,end,ispass)

        for i in range(len(find_road_path)-1):
            start,end = find_road_path[i],find_road_path[i+1]
            move(start,end,i < (len(find_road_path)-2))

    if Type in [1,2]:
        movel(trans(pos[7],[0,0,80,0,0,0]))
        for i in range(len(Path)):
            start,end = Path[i]
            ispass = i+1 <  len(Path) and Path[i+1][0] == end
            move(start,end,ispass)

    movej([90,0,90,0,90,0],150,150)

def mix_board():
    import random   
    global root,Rn,pos,live_board
    #A
    global find_road_start,find_road_end
    Rn = 0
    pos = posing(Positions()[0])
    new_start,new_end = random.randrange(0,72,12),random.randrange(11,72,12)
    obs_pos = lambda: [i for i in range(len(live_board[0])) if live_board[0][i] == '9'] 
    zero_pos = lambda: [i for i in range(len(live_board[0])) if live_board[0][i] == '0' and i != new_start]
    if live_board[0][new_start] != '0':
        move(new_start,zero_pos()[0],False,False)
    move(find_road_end,new_start,False,False)    
    for _ in range(20):
        move(random.choice(obs_pos()),random.choice(zero_pos()),False,False)
    movej([90,0,90,0,90,0],150,150)   

    #B
    Rn = 1
    pos = posing(Positions()[1])
    movel(trans(pos[7],[0,0,80,0,0,0]))
    one_pos =[i for i in range(len(live_board[1])) if live_board[1][i] == '1'] 
    two_pos = [i for i in range(len(live_board[1])) if live_board[1][i] == '2'] 
    zero_pos = lambda: [[i for i in range(len(live_board[1])) if live_board[1][i] == '0' and i < 7],
                                  [i for i in range(len(live_board[1])) if live_board[1][i] == '0'  and i > 7]]    
    for i in range(3):
        move(one_pos[i],random.choice(zero_pos()[1]),False,False)
        move(two_pos[i],random.choice(zero_pos()[0]),False,False)
        one_pos[i],two_pos[i] = None,None
    movej([90,0,90,0,90,0],150,150)

    #C
    Rn = 2
    pos = posing(Positions()[2])
    movel(trans(pos[7],[0,0,80,0,0,0]))
    pack_pos = lambda: [i for i in range(len(live_board[2])) if live_board[2][i] != '0'] 
    zero_pos = lambda: [i for i in range(len(live_board[2])) if live_board[2][i] == '0'] 
    for _ in range(15):
        move(random.choice(pack_pos()),random.choice(zero_pos()),False,False)        
    movej([90,0,90,0,90,0],150,150)

    live_board = list(map(''.join,live_board))
    root = [(live_board[0],new_start,new_end),live_board[1],live_board[2]]
    find_road_start,find_road_end = new_start,new_end

# Loop
loop_count = 0
while 1:
    live_board = list(map(list,live_board))
    loop_count += 1
    printf('-->',loop_count,'times Loop')
    sock = server_socket_open(20001)
    server_socket_write(sock,str(root).encode())
    result = eval(server_socket_read(sock)[1].decode())
    server_socket_close(sock)
    for i in range(3):
        Run(i)
    mix_board()